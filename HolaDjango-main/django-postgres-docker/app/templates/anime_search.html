{% extends 'base.html' %}

{% block title %}Búsqueda de Anime - Mi Aplicación Django{% endblock %}

{% block content %}
<!-- Encabezado de búsqueda -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title mb-4">
                    <i class="fas fa-search text-primary me-2"></i>
                    Búsqueda de Anime
                </h2>
                
                <!-- Formulario de búsqueda -->
                <form method="GET" class="mb-0">
                    <div class="input-group">
                        <input 
                            type="text" 
                            name="q" 
                            class="form-control form-control-lg" 
                            placeholder="Buscar anime... (ej: Naruto, One Piece, Attack on Titan)"
                            value="{{ query }}"
                            required
                        >
                        <button class="btn btn-primary btn-lg" type="submit">
                            <i class="fas fa-search me-1"></i>
                            Buscar
                        </button>
                    </div>
                    <small class="form-text text-muted mt-2">
                        Busca por nombre del anime en inglés o japonés
                    </small>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Mostrar error si existe -->
{% if error_message %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>
{% endif %}

<!-- Resultados de búsqueda -->
{% if query and not error_message %}
<div class="row mb-3">
    <div class="col-12">
        <h4 class="text-muted">
            {% if animes %}
                Resultados para "{{ query }}" ({{ animes|length }} encontrados)
            {% else %}
                No se encontraron resultados para "{{ query }}"
            {% endif %}
        </h4>
    </div>
</div>
{% endif %}

<!-- Grid de animes -->
{% if animes %}
<div class="row" id="anime-grid">
    {% for anime in animes %}
    <div class="col-lg-4 col-md-6 mb-4 anime-card">
        <div class="card h-100 shadow-sm">
            <!-- Imagen del anime -->
            <div class="position-relative">
                <img 
                    src="{{ anime.images.jpg.large_image_url|default:anime.images.jpg.image_url }}" 
                    class="card-img-top anime-image" 
                    alt="{{ anime.title }}"
                    style="height: 300px; object-fit: cover;"
                    loading="lazy"
                >
                
                <!-- Badge de puntuación -->
                {% if anime.score %}
                <span class="position-absolute top-0 end-0 badge bg-primary m-2">
                    <i class="fas fa-star me-1"></i>{{ anime.score }}
                </span>
                {% endif %}
                
                <!-- Badge de estado -->
                <span class="position-absolute top-0 start-0 badge 
                    {% if anime.status == 'Currently Airing' %}bg-success
                    {% elif anime.status == 'Finished Airing' %}bg-secondary
                    {% else %}bg-info{% endif %} m-2">
                    {{ anime.status }}
                </span>
            </div>

            <div class="card-body d-flex flex-column">
                <!-- Título -->
                <h5 class="card-title text-truncate" title="{{ anime.title }}">
                    {{ anime.title }}
                </h5>
                
                <!-- Título en inglés si es diferente -->
                {% if anime.title_english and anime.title_english != anime.title %}
                <h6 class="card-subtitle mb-2 text-muted text-truncate">
                    {{ anime.title_english }}
                </h6>
                {% endif %}

                <!-- Información básica -->
                <div class="mb-2">
                    <small class="text-muted d-block">
                        <i class="fas fa-tv me-1"></i>
                        {{ anime.type|default:"N/A" }} • 
                        {% if anime.episodes %}{{ anime.episodes }} eps{% else %}N/A{% endif %}
                    </small>
                    
                    {% if anime.year %}
                    <small class="text-muted d-block">
                        <i class="fas fa-calendar me-1"></i>{{ anime.year }}
                    </small>
                    {% endif %}
                </div>

                <!-- Géneros -->
                {% if anime.genres %}
                <div class="mb-3">
                    {% for genre in anime.genres|slice:":3" %}
                        <span class="badge bg-light text-dark me-1 mb-1">{{ genre.name }}</span>
                    {% endfor %}
                    {% if anime.genres|length > 3 %}
                        <span class="badge bg-light text-dark">+{{ anime.genres|length|add:"-3" }} más</span>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Sinopsis truncada -->
                {% if anime.synopsis %}
                <p class="card-text text-muted small mb-3" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                    {{ anime.synopsis|truncatewords:30 }}
                </p>
                {% endif %}

                <!-- Botones de acción -->
                <div class="mt-auto">
                    <div class="d-grid gap-2">
                       <!--- <a href="{% url 'anime_detail' anime.mal_id %}" class="btn btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>Ver Detalles
                        </a>-->
                        <button class="btn btn-success btn-save-anime" data-anime-id="{{ anime.mal_id }}">
                            <i class="fas fa-bookmark me-1"></i>Guardar Anime
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Mensaje de información sobre funcionalidad futura -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Nota:</strong> La funcionalidad de "Guardar Anime" se implementará próximamente.
        </div>
    </div>
</div>

{% elif query and not error_message %}
<!-- No hay resultados -->
<div class="row">
    <div class="col-12 text-center">
        <div class="card">
            <div class="card-body py-5">
                <i class="fas fa-search fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No se encontraron animes</h4>
                <p class="text-muted">Intenta con otro término de búsqueda</p>
                <small class="text-muted">
                    Sugerencias: Naruto, One Piece, Attack on Titan, Demon Slayer
                </small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Placeholder cuando no hay búsqueda -->
{% if not query %}
<div class="row">
    <div class="col-12 text-center">
        <div class="card">
            <div class="card-body py-5">
                <i class="fas fa-film fa-4x text-primary mb-3"></i>
                <h4>Descubre nuevos animes</h4>
                <p class="text-muted mb-4">
                    Utiliza el buscador para encontrar tus animes favoritos.<br>
                    Acceso a miles de títulos desde MyAnimeList.
                </p>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="row text-center">
                            <div class="col-4">
                                <i class="fas fa-star text-warning fa-2x mb-2"></i>
                                <small class="d-block text-muted">Calificaciones</small>
                            </div>
                            <div class="col-4">
                                <i class="fas fa-users text-info fa-2x mb-2"></i>
                                <small class="d-block text-muted">Comunidad</small>
                            </div>
                            <div class="col-4">
                                <i class="fas fa-bookmark text-success fa-2x mb-2"></i>
                                <small class="d-block text-muted">Guardar Favoritos</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animación de entrada para las cards
    const animeCards = document.querySelectorAll('.anime-card');
    animeCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // Manejo temporal del botón "Guardar Anime"
    const saveButtons = document.querySelectorAll('.btn-save-anime');
    saveButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const animeId = this.getAttribute('data-anime-id');
            
            // Cambiar estado del botón temporalmente
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
            this.disabled = true;
            
            // Simular guardado (remover cuando se implemente la funcionalidad real)
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-check me-1"></i>¡Guardado!';
                this.classList.remove('btn-success');
                this.classList.add('btn-outline-success');
                
                setTimeout(() => {
                    this.innerHTML = originalHTML;
                    this.classList.remove('btn-outline-success');
                    this.classList.add('btn-success');
                    this.disabled = false;
                }, 2000);
            }, 1000);
        });
    });

    // Mejorar carga de imágenes
    const images = document.querySelectorAll('.anime-image');
    images.forEach(img => {
        img.addEventListener('error', function() {
            this.src = 'https://via.placeholder.com/300x400/cccccc/666666?text=No+Image';
        });
    });
});
</script>
{% endblock %}